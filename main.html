<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dompet Digital - DANA Clone</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            -webkit-font-smoothing: antialiased; 
            -moz-osx-font-smoothing: grayscale;
        }
        .glass-card { 
            background: rgba(255, 255, 255, 0.05); 
            backdrop-filter: blur(12px); 
            -webkit-backdrop-filter: blur(12px); 
            border: 1px solid rgba(255, 255, 255, 0.1); 
        }
        .smooth-transition { transition: all 0.3s ease-in-out; }
        .pin-dot { width: 1rem; height: 1rem; border-radius: 50%; border: 2px solid #67e8f9; }
        .pin-dot.filled { background-color: #67e8f9; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .shake { animation: shake 0.3s ease-in-out; }
        .developer-card {
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
            border: 1px solid rgba(6, 182, 212, 0.2);
        }
        .social-link {
            transition: all 0.3s ease;
        }
        .social-link:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-900 via-indigo-900 to-purple-900 text-gray-200 min-h-screen">
    
    <!-- ===== LAYAR APLIKASI UTAMA (DASHBOARD & RIWAYAT) ===== -->
    <div class="min-h-screen w-full flex flex-col">
        <!-- Konten dinamis (Dashboard, Riwayat, atau Profil) akan muncul di sini -->
        <div id="main-app-content" class="flex-grow p-4 md:p-8"></div>

        <!-- Bottom Navigation -->
        <nav class="sticky bottom-0 left-0 w-full glass-card p-2">
            <div class="max-w-4xl mx-auto flex justify-around items-center">
                <button data-target="dashboard-view" class="nav-btn flex flex-col items-center text-cyan-300 w-full p-2 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                    </svg>
                    <span class="text-xs font-semibold">Home</span>
                </button>
                <button data-target="history-view" class="nav-btn flex flex-col items-center text-gray-400 w-full p-2 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 110 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
                    </svg>
                    <span class="text-xs font-semibold">Riwayat</span>
                </button>
                <button data-target="profile-view" class="nav-btn flex flex-col items-center text-gray-400 w-full p-2 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                    <span class="text-xs font-semibold">Profil</span>
                </button>
            </div>
        </nav>
    </div>

    <!-- ===== KUMPULAN MODAL (POP-UP) ===== -->
    <div id="modal-backdrop" class="fixed inset-0 bg-black/60 z-40 hidden"></div>
    
    <div id="transfer-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
        <div class="glass-card w-full max-w-md p-6 rounded-2xl shadow-2xl">
            <h3 class="text-xl font-bold mb-4">Transfer Saldo</h3>
            <form id="transfer-form">
                <div>
                    <label for="recipient-phone" class="text-sm font-medium text-indigo-200">No. Telepon Penerima</label>
                    <input type="tel" id="recipient-phone" required class="w-full p-3 mt-1 bg-gray-800/50 border-2 border-indigo-700 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:outline-none" placeholder="08xxxxxxxxxx">
                </div>
                <div class="mt-4">
                    <label for="transfer-amount" class="text-sm font-medium text-indigo-200">Jumlah Transfer</label>
                    <input type="number" id="transfer-amount" required class="w-full p-3 mt-1 bg-gray-800/50 border-2 border-indigo-700 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:outline-none" placeholder="Rp 0">
                </div>
                <div class="flex gap-4 mt-6">
                    <button type="button" class="modal-close-btn w-1/2 bg-gray-600/50 text-white font-bold py-3 rounded-lg">Batal</button>
                    <button type="submit" class="w-1/2 bg-gradient-to-r from-cyan-500 to-blue-500 text-white font-bold py-3 rounded-lg">Lanjutkan</button>
                </div>
            </form>
        </div>
    </div>

    <div id="pin-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
        <div class="glass-card w-full max-w-xs p-6 rounded-2xl shadow-2xl text-center relative">
            <button id="pin-modal-close-btn" class="absolute top-2 right-3 text-2xl text-gray-400 hover:text-white hidden">&times;</button>
            <h3 class="text-xl font-bold mb-2">Masukkan PIN</h3>
            <p class="text-sm text-gray-400 mb-6">Untuk keamanan transaksi</p>
            <div id="pin-dots-container" class="flex justify-center gap-3 mb-6">
                <div class="pin-dot"></div>
                <div class="pin-dot"></div>
                <div class="pin-dot"></div>
                <div class="pin-dot"></div>
                <div class="pin-dot"></div>
                <div class="pin-dot"></div>
            </div>
            <input type="number" id="pin-input-hidden" class="opacity-0 absolute">
            <p id="pin-error" class="text-red-400 text-sm mt-2 h-4"></p>
        </div>
    </div>

    <div id="history-detail-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
        <div class="glass-card w-full max-w-md p-6 rounded-2xl shadow-2xl">
            <div class="flex justify-between items-start">
                <h3 class="text-xl font-bold mb-4">Detail Transaksi</h3>
                <button class="modal-close-btn text-2xl">&times;</button>
            </div>
            <div class="space-y-3 text-sm">
                <div class="flex justify-between">
                    <span class="text-gray-400">Status</span>
                    <span id="detail-status" class="font-semibold"></span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-400">Tanggal & Waktu</span>
                    <span id="detail-datetime" class="font-semibold"></span>
                </div>
                <div class="border-t border-white/10 my-3"></div>
                <div id="detail-sender-block" class="hidden flex justify-between">
                    <span class="text-gray-400">Pengirim</span>
                    <span id="detail-sender" class="font-semibold text-right"></span>
                </div>
                <div id="detail-recipient-block" class="hidden flex justify-between">
                    <span class="text-gray-400">Penerima</span>
                    <span id="detail-recipient" class="font-semibold text-right"></span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-400">Nominal</span>
                    <span id="detail-amount" class="font-semibold"></span>
                </div>
                <div class="border-t border-white/10 my-3"></div>
                <div class="flex justify-between">
                    <span class="text-gray-400">ID Transaksi</span>
                    <span id="detail-txid" class="font-semibold text-right break-all"></span>
                </div>
                <div id="detail-order-block" class="flex justify-between">
                    <span class="text-gray-400">ID Order</span>
                    <span id="detail-orderid" class="font-semibold text-right break-all"></span>
                </div>
            </div>
        </div>
    </div>

    <div id="notification-modal" class="fixed top-8 left-1/2 -translate-x-1/2 z-50 hidden">
        <div id="notification-card" class="p-4 rounded-lg text-white font-semibold shadow-2xl min-w-[250px] text-center">
            <p id="notification-message"></p>
        </div>
    </div>

    <!-- Profile Settings Modals -->
    <div id="security-settings-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
        <div class="glass-card w-full max-w-md p-6 rounded-2xl shadow-2xl">
            <h3 class="text-xl font-bold mb-4">Pengaturan Keamanan</h3>
            <div class="space-y-4">
                <button class="w-full glass-card p-4 rounded-lg text-left hover:border-cyan-400 smooth-transition">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="font-semibold">Ubah PIN</p>
                            <p class="text-sm text-gray-400">Ganti PIN transaksi Anda</p>
                        </div>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </div>
                </button>
                <button class="w-full glass-card p-4 rounded-lg text-left hover:border-cyan-400 smooth-transition">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="font-semibold">Fingerprint</p>
                            <p class="text-sm text-gray-400">Aktifkan login dengan sidik jari</p>
                        </div>
                        <div class="w-12 h-6 bg-gray-600 rounded-full p-1">
                            <div class="w-4 h-4 bg-white rounded-full"></div>
                        </div>
                    </div>
                </button>
                <button class="w-full glass-card p-4 rounded-lg text-left hover:border-cyan-400 smooth-transition">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="font-semibold">Riwayat Login</p>
                            <p class="text-sm text-gray-400">Lihat aktivitas login Anda</p>
                        </div>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </div>
                </button>
            </div>
            <button class="modal-close-btn mt-6 w-full bg-gray-600/50 text-white font-bold py-3 rounded-lg">Tutup</button>
        </div>
    </div>

    <div id="help-support-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
        <div class="glass-card w-full max-w-md p-6 rounded-2xl shadow-2xl">
            <h3 class="text-xl font-bold mb-4">Bantuan & Dukungan</h3>
            <div class="space-y-4">
                <button class="w-full glass-card p-4 rounded-lg text-left hover:border-cyan-400 smooth-transition">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="font-semibold">FAQ</p>
                            <p class="text-sm text-gray-400">Pertanyaan yang sering diajukan</p>
                        </div>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </div>
                </button>
                <a href="tel:089515199789" class="w-full glass-card p-4 rounded-lg text-left hover:border-green-400 smooth-transition block">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="font-semibold">Hubungi Customer Service</p>
                            <p class="text-sm text-gray-400">089515199789</p>
                        </div>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                        </svg>
                    </div>
                </a>
                <a href="https://wa.me/6289515199789" target="_blank" class="w-full glass-card p-4 rounded-lg text-left hover:border-green-400 smooth-transition block">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="font-semibold">Chat WhatsApp</p>
                            <p class="text-sm text-gray-400">Hubungi via WhatsApp</p>
                        </div>
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.885 3.488"/>
                        </svg>
                    </div>
                </a>
            </div>
            <button class="modal-close-btn mt-6 w-full bg-gray-600/50 text-white font-bold py-3 rounded-lg">Tutup</button>
        </div>
    </div>

    <!-- ===== SCRIPT APLIKASI ===== -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, runTransaction, onSnapshot, collection, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // GANTI INI DENGAN KONFIGURASI FIREBASE MILIK ANDA YANG ASLI
        const firebaseConfig = {
          apiKey: "AIzaSyBv31cJC19pEpa6EpamkgaexRdpN0425TKsY",
          authDomain: "imammulmu322.firebaseapp.com",
          projectId: "imammulmu322",
          storageBucket: "imammulmu322.appspot.com",
          messagingSenderId: "1048023716109",
          appId: "1:1048023716109:web:e467f867fdd9104ed518b4"
        };
        
        // --- Inisialisasi Firebase & Variabel Global ---
        let db, auth, currentUser = null; 
        let unsubscribeUser, unsubscribeHistory;
        let currentTransaction = {};
        let isInitialHistoryLoad = true;

        // --- Template Tampilan ---
        const dashboardViewHTML = `
            <header class="w-full max-w-4xl mx-auto flex justify-between items-center mb-8">
                <div>
                    <p class="text-gray-400">Selamat datang,</p>
                    <h1 id="username-display" class="text-2xl font-bold"></h1>
                </div>
                <button id="logout-btn" class="glass-card p-3 rounded-full hover:bg-red-500/50 smooth-transition" title="Logout">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                </button>
            </header>
            <div class="w-full max-w-4xl mx-auto glass-card rounded-2xl p-6 shadow-2xl mb-10">
                <p class="text-indigo-200 text-lg">Saldo Anda</p>
                <p id="balance-display" class="text-4xl md:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 to-green-300 mt-2">Rp 0</p>
            </div>
            
            <!-- Developer Info Section -->
            <div class="w-full max-w-4xl mx-auto developer-card rounded-2xl p-6 shadow-2xl mb-8">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h3 class="text-lg font-bold text-cyan-300">Tentang Pengembang</h3>
                        <p class="text-sm text-gray-400">Hubungi developer untuk support</p>
                    </div>
                    <div class="w-12 h-12 bg-gradient-to-r from-cyan-400 to-blue-500 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
                        </svg>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-3">
                    <a href="https://www.tiktok.com/@faktapopuler96?_t=ZS-8xDot2GJcZ7&_r=1" target="_blank" class="social-link glass-card p-3 rounded-lg flex flex-col items-center justify-center hover:border-pink-400 smooth-transition">
                        <svg class="w-6 h-6 mb-1 text-pink-400" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M19.59 6.69a4.83 4.83 0 01-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 01-5.2 1.74 2.89 2.89 0 012.31-4.64 2.93 2.93 0 01.88.13V9.4a6.84 6.84 0 00-.88-.05A6.33 6.33 0 005 20.1a6.34 6.34 0 0010.86-4.43v-7a8.16 8.16 0 004.77 1.52v-3.4a4.85 4.85 0 01-1-.1z"/>
                        </svg>
                        <span class="text-xs font-semibold">TikTok</span>
                    </a>
                    <a href="https://wa.me/6289515199789" target="_blank" class="social-link glass-card p-3 rounded-lg flex flex-col items-center justify-center hover:border-green-400 smooth-transition">
                        <svg class="w-6 h-6 mb-1 text-green-400" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.885 3.488"/>
                        </svg>
                        <span class="text-xs font-semibold">WhatsApp</span>
                    </a>
                    <a href="tel:089515199789" class="social-link glass-card p-3 rounded-lg flex flex-col items-center justify-center hover:border-blue-400 smooth-transition">
                        <svg class="w-6 h-6 mb-1 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                        </svg>
                        <span class="text-xs font-semibold">Telepon</span>
                    </a>
                </div>
            </div>

            <div class="w-full max-w-4xl mx-auto grid grid-cols-3 gap-4 text-center mb-6">
                <button id="show-transfer-btn" class="glass-card p-4 rounded-xl flex flex-col items-center justify-center hover:border-cyan-400 smooth-transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mb-2 text-cyan-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01" />
                    </svg>
                    <span class="font-semibold">Transfer</span>
                </button>
                <button id="show-topup-btn" class="glass-card p-4 rounded-xl flex flex-col items-center justify-center hover:border-green-400 smooth-transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mb-2 text-green-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span class="font-semibold">Top Up</span>
                </button>
                <button id="show-pinjam-btn" class="glass-card p-4 rounded-xl flex flex-col items-center justify-center hover:border-yellow-400 smooth-transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mb-2 text-yellow-300" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                    </svg>
                    <span class="font-semibold">Pinjam</span>
                </button>
            </div>
            <div class="w-full max-w-4xl mx-auto grid grid-cols-3 gap-4 text-center">
                <button id="show-link-btn" class="glass-card p-4 rounded-xl flex flex-col items-center justify-center hover:border-purple-400 smooth-transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mb-2 text-purple-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                    </svg>
                    <span class="font-semibold">Link</span>
                </button>
                <a href="Link.html" class="glass-card p-4 rounded-xl flex flex-col items-center justify-center hover:border-orange-400 smooth-transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mb-2 text-orange-300" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M3 1a1 1 0 000 2h1.22l.305 1.222a.997.997 0 00.01.042l1.358 5.43-.893.892C3.74 11.846 4.632 14 6.414 14H15a1 1 0 000-2H6.414l1-1H14a1 1 0 00.894-.553l3-6A1 1 0 0017 3H6.28l-.31-1.243A1 1 0 005 1H3zM16 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM6.5 18a1.5 1.5 0 100-3 1.5 1.5 0 000 3z" />
                    </svg>
                    <span class="font-semibold">Toko</span>
                </a>
                <div class="glass-card p-4 rounded-xl flex flex-col items-center justify-center opacity-50 cursor-not-allowed">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
                    </svg>
                    <span class="font-semibold">Bayar</span>
                </div>
            </div>`;

        const historyViewHTML = `
            <div class="w-full max-w-4xl mx-auto">
                <h1 class="text-3xl font-bold mb-6 text-cyan-300">Riwayat Transaksi</h1>
                <div id="history-list" class="space-y-4"></div>
            </div>`;
        
        const profileViewHTML = `
            <div class="w-full max-w-4xl mx-auto">
                <h1 class="text-3xl font-bold mb-6 text-cyan-300">Profil Saya</h1>
                
                <!-- Profile Header -->
                <div class="glass-card p-6 rounded-2xl mb-6">
                    <div class="flex items-center space-x-4">
                        <img id="profile-picture" src="foto.jpg" alt="Foto Profil" class="w-20 h-20 rounded-full object-cover border-2 border-cyan-400" onerror="this.onerror=null;this.src='https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=80&h=80&fit=crop&crop=face&facepad=2&fm=jpg';">
                        <div>
                            <p id="profile-name" class="text-xl font-bold"></p>
                            <p id="profile-phone" class="text-gray-400"></p>
                            <div class="flex items-center mt-1">
                                <div class="w-2 h-2 bg-green-400 rounded-full mr-2"></div>
                                <span class="text-sm text-green-400">Akun Terverifikasi</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="glass-card p-6 rounded-2xl">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-400">Total Uang Masuk</p>
                                <p id="profile-money-in" class="text-2xl font-bold text-green-400 mt-1">Rp 0</p>
                            </div>
                            <div class="w-12 h-12 bg-green-500/20 rounded-full flex items-center justify-center">
                                <svg class="w-6 h-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 11l5-5m0 0l5 5m-5-5v12"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                    <div class="glass-card p-6 rounded-2xl">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-400">Total Uang Keluar</p>
                                <p id="profile-money-out" class="text-2xl font-bold text-red-400 mt-1">Rp 0</p>
                            </div>
                            <div class="w-12 h-12 bg-red-500/20 rounded-full flex items-center justify-center">
                                <svg class="w-6 h-6 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 13l-5 5m0 0l-5-5m5 5V6"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="glass-card p-6 rounded-2xl mb-6">
                    <h3 class="text-lg font-bold mb-4">Aksi Cepat</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <button class="glass-card p-4 rounded-lg flex items-center space-x-3 hover:border-cyan-400 smooth-transition">
                            <div class="w-10 h-10 bg-cyan-500/20 rounded-full flex items-center justify-center">
                                <svg class="w-5 h-5 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"></path>
                                </svg>
                            </div>
                            <div class="text-left">
                                <p class="font-semibold">Bagikan Profil</p>
                                <p class="text-sm text-gray-400">Share ke teman</p>
                            </div>
                        </button>
                        <button class="glass-card p-4 rounded-lg flex items-center space-x-3 hover:border-purple-400 smooth-transition">
                            <div class="w-10 h-10 bg-purple-500/20 rounded-full flex items-center justify-center">
                                <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                            </div>
                            <div class="text-left">
                                <p class="font-semibold">Unduh Laporan</p>
                                <p class="text-sm text-gray-400">Export transaksi</p>
                            </div>
                        </button>
                    </div>
                </div>

                <!-- Settings Menu -->
                <div class="space-y-4 mb-6">
                    <h3 class="text-lg font-bold text-gray-300">Pengaturan</h3>
                    
                    <button id="security-settings-btn" class="w-full glass-card p-4 rounded-lg flex items-center justify-between hover:border-cyan-400 smooth-transition">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-red-500/20 rounded-full flex items-center justify-center">
                                <svg class="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                                </svg>
                            </div>
                            <div class="text-left">
                                <p class="font-semibold">Keamanan</p>
                                <p class="text-sm text-gray-400">PIN, Password & Biometrik</p>
                            </div>
                        </div>
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </button>

                    <button class="w-full glass-card p-4 rounded-lg flex items-center justify-between hover:border-cyan-400 smooth-transition">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-blue-500/20 rounded-full flex items-center justify-center">
                                <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-5 5v-5zM4.828 10l6.586 6.586a2 2 0 002.828 0l6.586-6.586a2 2 0 000-2.828L14.242 1.586a2 2 0 00-2.828 0L4.828 7.172a2 2 0 000 2.828z"></path>
                                </svg>
                            </div>
                            <div class="text-left">
                                <p class="font-semibold">Notifikasi</p>
                                <p class="text-sm text-gray-400">Atur preferensi notifikasi</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <div class="w-10 h-5 bg-cyan-500 rounded-full p-1">
                                <div class="w-3 h-3 bg-white rounded-full ml-auto"></div>
                            </div>
                        </div>
                    </button>

                    <button class="w-full glass-card p-4 rounded-lg flex items-center justify-between hover:border-cyan-400 smooth-transition">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-green-500/20 rounded-full flex items-center justify-center">
                                <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                                </svg>
                            </div>
                            <div class="text-left">
                                <p class="font-semibold">Limit Transaksi</p>
                                <p class="text-sm text-gray-400">Atur batas harian & bulanan</p>
                            </div>
                        </div>
                        <span class="text-sm text-gray-400">Rp 5,000,000</span>
                    </button>

                    <button class="w-full glass-card p-4 rounded-lg flex items-center justify-between hover:border-cyan-400 smooth-transition">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-yellow-500/20 rounded-full flex items-center justify-center">
                                <svg class="w-5 h-5 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div class="text-left">
                                <p class="font-semibold">Riwayat Login</p>
                                <p class="text-sm text-gray-400">Lihat aktivitas masuk akun</p>
                            </div>
                        </div>
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </button>

                    <button id="help-support-btn" class="w-full glass-card p-4 rounded-lg flex items-center justify-between hover:border-cyan-400 smooth-transition">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-indigo-500/20 rounded-full flex items-center justify-center">
                                <svg class="w-5 h-5 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div class="text-left">
                                <p class="font-semibold">Bantuan & Dukungan</p>
                                <p class="text-sm text-gray-400">FAQ & Customer Service</p>
                            </div>
                        </div>
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </button>

                    <button class="w-full glass-card p-4 rounded-lg flex items-center justify-between hover:border-cyan-400 smooth-transition">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-gray-500/20 rounded-full flex items-center justify-center">
                                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                            </div>
                            <div class="text-left">
                                <p class="font-semibold">Syarat & Ketentuan</p>
                                <p class="text-sm text-gray-400">Kebijakan penggunaan</p>
                            </div>
                        </div>
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </button>
                </div>

                <!-- Footer Info -->
                <div class="text-center text-gray-500 text-sm space-y-2">
                    <p>Dompet Digital v1.2.0</p>
                    <p class="text-xs">Dikembangkan dengan ❤️ untuk kemudahan transaksi digital</p>
                    <div class="flex justify-center space-x-4 mt-4">
                        <a href="https://www.tiktok.com/@faktapopuler96?_t=ZS-8xDot2GJcZ7&_r=1" target="_blank" class="text-gray-500 hover:text-pink-400 smooth-transition">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M19.59 6.69a4.83 4.83 0 01-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 01-5.2 1.74 2.89 2.89 0 012.31-4.64 2.93 2.93 0 01.88.13V9.4a6.84 6.84 0 00-.88-.05A6.33 6.33 0 005 20.1a6.34 6.34 0 0010.86-4.43v-7a8.16 8.16 0 004.77 1.52v-3.4a4.85 4.85 0 01-1-.1z"/>
                            </svg>
                        </a>
                        <a href="https://wa.me/6289515199789" target="_blank" class="text-gray-500 hover:text-green-400 smooth-transition">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.885 3.488"/>
                            </svg>
                        </a>
                        <a href="tel:089515199789" class="text-gray-500 hover:text-blue-400 smooth-transition">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                            </svg>
                        </a>
                    </div>
                </div>
            </div>`;

        // --- Fungsi Utama UI & Tampilan ---
        const mainAppContainer = document.getElementById('main-app-content');
        const showMainAppView = (viewName) => {
            mainAppContainer.innerHTML = ''; 
            isInitialHistoryLoad = true;
            if (unsubscribeHistory) unsubscribeHistory();

            if (viewName === 'dashboard-view') {
                mainAppContainer.innerHTML = dashboardViewHTML;
                document.getElementById('logout-btn').addEventListener('click', handleLogout);
                document.getElementById('show-transfer-btn').addEventListener('click', () => openModal('transfer-modal'));
                document.getElementById('show-topup-btn').addEventListener('click', () => {
                    window.location.href = `Topup.html?phone=${currentUser.phoneNumber}`;
                });
                document.getElementById('show-pinjam-btn').addEventListener('click', () => {
                    window.location.href = `PinjamUang.html?phone=${currentUser.phoneNumber}`;
                });
                document.getElementById('show-link-btn').addEventListener('click', () => {
                    window.location.href = `Link.html?phone=${currentUser.phoneNumber}&balance=${currentUser.balance}`;
                });
                updateDashboardUI();
                listenForHistory(null, true);
            } else if (viewName === 'history-view') {
                mainAppContainer.innerHTML = historyViewHTML;
                listenForHistory(renderHistory);
            } else if (viewName === 'profile-view') {
                mainAppContainer.innerHTML = profileViewHTML;
                // Add event listeners for profile buttons
                document.getElementById('security-settings-btn').addEventListener('click', () => openModal('security-settings-modal'));
                document.getElementById('help-support-btn').addEventListener('click', () => openModal('help-support-modal'));
                listenForHistory(renderProfileStats);
            }
             document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.toggle('text-cyan-300', btn.dataset.target === viewName);
                btn.classList.toggle('text-gray-400', btn.dataset.target !== viewName);
            });
        };

        const updateDashboardUI = () => {
             if(currentUser && document.getElementById('username-display')) {
                document.getElementById('username-display').innerText = currentUser.username;
                const formattedBalance = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(currentUser.balance);
                document.getElementById('balance-display').innerText = formattedBalance;
            }
        };

        const loadUserDashboard = (userData) => {
            currentUser = userData;
            if (unsubscribeUser) unsubscribeUser();
            isInitialHistoryLoad = true;

            const userRef = doc(db, "users", currentUser.phoneNumber);
            unsubscribeUser = onSnapshot(userRef, (doc) => {
                if (doc.exists()) {
                    currentUser = { ...doc.data(), phoneNumber: doc.id };
                    updateDashboardUI();
                } else { handleLogout(); }
            });
            showMainAppView('dashboard-view');
        };
        
        const showNotification = (message, isError = false) => {
            const notifModal = document.getElementById('notification-modal');
            const notifCard = document.getElementById('notification-card');
            const notifMessage = document.getElementById('notification-message');
            notifMessage.innerText = message;
            notifCard.className = `p-4 rounded-lg text-white font-semibold shadow-2xl min-w-[250px] text-center ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            notifModal.style.display = 'flex';
            setTimeout(() => { notifModal.style.display = 'none'; }, 3000);
        };

        const openModal = (modalId) => {
            if (modalId === 'pin-modal') {
                document.getElementById('pin-modal-close-btn').classList.add('hidden');
                document.getElementById('pin-error').innerText = '';
            }
            document.getElementById(modalId).style.display = 'flex';
            document.getElementById('modal-backdrop').style.display = 'block';
        };

        const closeModal = () => {
            document.querySelectorAll('.fixed.inset-0.z-50').forEach(el => el.style.display = 'none');
            document.getElementById('modal-backdrop').style.display = 'none';
        };
        
        const handleLogout = () => {
            if (unsubscribeUser) unsubscribeUser();
            if (unsubscribeHistory) unsubscribeHistory();
            currentUser = null;
            window.location.href = 'index.html';
        };

        // --- Fungsi Riwayat & Profil ---
        const listenForHistory = (renderFunction, backgroundMode = false) => {
            if (!currentUser) return;
            if (unsubscribeHistory) unsubscribeHistory();
            const historyRef = collection(db, "users", currentUser.phoneNumber, "history");
            const q = query(historyRef, orderBy("timestamp", "desc"));
            unsubscribeHistory = onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added" && !isInitialHistoryLoad) {
                        const tx = change.doc.data();
                        if (tx.type === 'MASUK') {
                            const formattedAmount = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(tx.amount);
                            showNotification(`Hai! ${tx.otherPartyName} baru saja kirim ${formattedAmount} ke akun kamu.`);
                        }
                    }
                });
                if (!backgroundMode && typeof renderFunction === 'function') {
                    const allHistoryDocs = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                    renderFunction(allHistoryDocs);
                }
                isInitialHistoryLoad = false;
            });
        };

        const renderHistory = (historyData) => {
            const historyList = document.getElementById('history-list');
            if (!historyList) return;
            historyList.innerHTML = '';
            if (historyData.length === 0) {
                historyList.innerHTML = '<p class="text-center text-gray-400">Belum ada riwayat transaksi.</p>';
                return;
            }
            historyData.forEach(tx => {
                if(!tx.timestamp) return; 
                const date = tx.timestamp.toDate();
                const formattedDate = date.toLocaleString('id-ID', { day: 'numeric', month: 'short', year:'numeric' });
                const formattedAmount = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(tx.amount);
                let title, partyInfo, amountClass;
                switch(tx.type) {
                    case 'MASUK': title = 'Terima Dana'; partyInfo = `Dari: ${tx.otherPartyName}`; amountClass = 'text-green-400'; break;
                    case 'KELUAR': title = 'Transfer Keluar'; partyInfo = `Ke: ${tx.otherPartyName}`; amountClass = 'text-red-400'; break;
                    case 'TOPUP': title = 'Top Up Saldo'; partyInfo = `Melalui sistem`; amountClass = 'text-blue-400'; break;
                    case 'PINJAMAN': title = 'Pinjaman Disetujui'; partyInfo = `ID: ${tx.loanId}`; amountClass = 'text-yellow-400'; break;
                    case 'BAYAR_PINJAMAN': title = 'Bayar Pinjaman'; partyInfo = `ID: ${tx.loanId}`; amountClass = 'text-red-400'; break;
                    case 'BELI_LINK': title = 'Pembelian Link'; partyInfo = `${tx.linkTitle}`; amountClass = 'text-red-400'; break;
                }
                const item = document.createElement('div');
                item.className = 'glass-card p-4 rounded-lg flex items-center justify-between cursor-pointer hover:border-cyan-400 smooth-transition';
                item.innerHTML = `<div><p class="font-bold ${amountClass}">${title}</p><p class="text-sm text-gray-300">${partyInfo}</p><p class="text-xs text-gray-500 mt-1">ID: ${tx.transactionId}</p></div><div class="text-right"><p class="font-bold text-lg ${amountClass}">${tx.type === 'KELUAR' || tx.type === 'BAYAR_PINJAMAN' || tx.type === 'BELI_LINK' ? '-' : '+'} ${formattedAmount}</p><p class="text-xs text-gray-500">${formattedDate}</p></div>`;
                item.addEventListener('click', () => showHistoryDetail(tx));
                historyList.appendChild(item);
            });
        };

        const renderProfileStats = (historyData) => {
            if (!currentUser) return;
            const profilePic = document.getElementById('profile-picture');
            if (profilePic) {
                profilePic.onerror = () => {
                    const initialDiv = document.createElement('div');
                    initialDiv.className = 'w-20 h-20 bg-cyan-500 rounded-full flex items-center justify-center text-3xl font-bold';
                    initialDiv.textContent = currentUser.username.charAt(0).toUpperCase();
                    profilePic.replaceWith(initialDiv);
                };
            }
            document.getElementById('profile-name').textContent = currentUser.username;
            document.getElementById('profile-phone').textContent = currentUser.phoneNumber;
            let totalIn = 0;
            let totalOut = 0;
            historyData.forEach(tx => {
                if (tx.type === 'MASUK' || tx.type === 'TOPUP' || tx.type === 'PINJAMAN') {
                    totalIn += tx.amount;
                } else if (tx.type === 'KELUAR' || tx.type === 'BAYAR_PINJAMAN' || tx.type === 'BELI_LINK') {
                    totalOut += tx.amount;
                }
            });
            document.getElementById('profile-money-in').textContent = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(totalIn);
            document.getElementById('profile-money-out').textContent = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(totalOut);
        };

        const showHistoryDetail = (tx) => {
            const date = tx.timestamp.toDate();
            const formattedDate = date.toLocaleString('id-ID', { dateStyle: 'full', timeStyle: 'short' });
            const formattedAmount = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(tx.amount);
            let statusText, statusClass;
            switch(tx.type) {
                case 'MASUK': case 'KELUAR': case 'TOPUP': case 'PINJAMAN': case 'BAYAR_PINJAMAN': case 'BELI_LINK': statusText = 'BERHASIL'; statusClass = 'text-green-400'; break;
                default: statusText = 'TIDAK DIKETAHUI'; statusClass = 'text-gray-400';
            }
            document.getElementById('detail-status').textContent = statusText;
            document.getElementById('detail-status').className = `font-semibold ${statusClass}`;
            document.getElementById('detail-datetime').textContent = formattedDate;
            document.getElementById('detail-amount').textContent = formattedAmount;
            document.getElementById('detail-txid').textContent = tx.transactionId;
            const senderBlock = document.getElementById('detail-sender-block');
            const recipientBlock = document.getElementById('detail-recipient-block');
            const orderBlock = document.getElementById('detail-order-block');
            senderBlock.style.display = 'none'; recipientBlock.style.display = 'none'; orderBlock.style.display = 'none';
            if(tx.type === 'KELUAR' || tx.type === 'MASUK') {
                senderBlock.style.display = 'flex'; recipientBlock.style.display = 'flex'; orderBlock.style.display = 'flex';
                const senderName = tx.type === 'KELUAR' ? currentUser.username : tx.otherPartyName;
                const senderPhone = tx.type === 'KELUAR' ? currentUser.phoneNumber : tx.otherPartyPhone;
                const recipientName = tx.type === 'KELUAR' ? tx.otherPartyName : currentUser.username;
                const recipientPhone = tx.type === 'KELUAR' ? tx.otherPartyPhone : currentUser.phoneNumber;
                document.getElementById('detail-sender').innerHTML = `${senderName}<br><span class="text-xs text-gray-400">${senderPhone}</span>`;
                document.getElementById('detail-recipient').innerHTML = `${recipientName}<br><span class="text-xs text-gray-400">${recipientPhone}</span>`;
                document.getElementById('detail-orderid').textContent = tx.merchantOrderId;
            }
            openModal('history-detail-modal');
        };
        
        // --- Fungsi Transaksi ---
        const handleTransferSubmit = (e) => {
            e.preventDefault();
            const recipientPhone = document.getElementById('recipient-phone').value;
            const amount = parseInt(document.getElementById('transfer-amount').value);
            if (recipientPhone === currentUser.phoneNumber) { showNotification("Tidak bisa transfer ke diri sendiri.", true); return; }
            if (amount <= 0 || !amount) { showNotification("Jumlah transfer tidak valid.", true); return; }
            if (amount > currentUser.balance) { showNotification("Saldo tidak mencukupi.", true); return; }
            currentTransaction = { type: 'transfer', recipientPhone, amount };
            closeModal();
            openModal('pin-modal');
            document.getElementById('pin-input-hidden').focus();
        };

        const executeTransfer = async () => {
            try {
                const transactionId = `TRX-${Date.now()}`;
                const merchantOrderId = `ORDER-${crypto.randomUUID().slice(0, 8)}`;
                await runTransaction(db, async (transaction) => {
                    const senderRef = doc(db, "users", currentUser.phoneNumber);
                    const recipientRef = doc(db, "users", currentTransaction.recipientPhone);
                    const senderDoc = await transaction.get(senderRef);
                    const recipientDoc = await transaction.get(recipientRef);
                    if (!senderDoc.exists()) throw "Pengirim tidak ditemukan.";
                    if (!recipientDoc.exists()) throw "Penerima tidak ditemukan.";
                    const senderData = senderDoc.data();
                    const newSenderBalance = senderData.balance - currentTransaction.amount;
                    if (newSenderBalance < 0) throw "Saldo tidak mencukupi.";
                    const recipientData = recipientDoc.data();
                    const newRecipientBalance = recipientData.balance + currentTransaction.amount;
                    transaction.update(senderRef, { balance: newSenderBalance });
                    transaction.update(recipientRef, { balance: newRecipientBalance });
                    const senderHistoryRef = doc(collection(db, "users", currentUser.phoneNumber, "history"));
                    transaction.set(senderHistoryRef, { type: 'KELUAR', amount: currentTransaction.amount, timestamp: serverTimestamp(), transactionId, merchantOrderId, otherPartyName: recipientData.username, otherPartyPhone: currentTransaction.recipientPhone });
                    const recipientHistoryRef = doc(collection(db, "users", currentTransaction.recipientPhone, "history"));
                    transaction.set(recipientHistoryRef, { type: 'MASUK', amount: currentTransaction.amount, timestamp: serverTimestamp(), transactionId, merchantOrderId, otherPartyName: senderData.username, otherPartyPhone: currentUser.phoneNumber });
                });
                showNotification("Transfer berhasil!");
            } catch (error) {
                console.error("Transfer gagal: ", error);
                showNotification(`Transfer gagal: ${error}`, true);
            }
        };

        const handlePinInput = async (pin) => {
            if (pin === currentUser.pin) {
                document.getElementById('pin-error').innerText = '';
                closeModal();
                showNotification("PIN Benar! Memproses...");
                if (currentTransaction.type === 'transfer') {
                    await executeTransfer();
                }
            } else {
                const pinDots = document.getElementById('pin-dots-container');
                pinDots.classList.add('shake');
                document.getElementById('pin-error').innerText = 'PIN salah!';
                document.getElementById('pin-modal-close-btn').classList.remove('hidden');
                setTimeout(() => pinDots.classList.remove('shake'), 300);
            }
        };

        // --- Inisialisasi Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                signInAnonymously(auth);
            } catch (e) { console.error("Gagal konek Firebase:", e); alert("Gagal terhubung ke Firebase. Cek konfigurasi."); }

            // Ambil parameter phone dari URL
            const urlParams = new URLSearchParams(window.location.search);
            const phoneNumber = urlParams.get('phone');
            
            if (!phoneNumber) {
                showNotification('Akses tidak valid. Silakan login kembali.', true);
                setTimeout(() => window.location.href = 'index.html', 2000);
                return;
            }

            // Load user data
            const loadUser = async () => {
                try {
                    const userRef = doc(db, "users", phoneNumber);
                    const userDoc = await getDoc(userRef);
                    
                    if (userDoc.exists()) {
                        const userData = { ...userDoc.data(), phoneNumber: userDoc.id };
                        loadUserDashboard(userData);
                    } else {
                        showNotification('Data pengguna tidak ditemukan.', true);
                        setTimeout(() => window.location.href = 'index.html', 2000);
                    }
                } catch (error) {
                    console.error('Error loading user:', error);
                    showNotification('Gagal memuat data pengguna.', true);
                }
            };

            loadUser();
            
            document.querySelectorAll('.modal-close-btn').forEach(btn => btn.addEventListener('click', closeModal));
            document.getElementById('pin-modal-close-btn').addEventListener('click', closeModal);

            document.getElementById('pin-input-hidden').addEventListener('input', (e) => {
                const pin = e.target.value;
                const dots = document.querySelectorAll('#pin-dots-container .pin-dot');
                dots.forEach((dot, index) => { dot.classList.toggle('filled', index < pin.length); });
                if (pin.length === 6) { handlePinInput(pin); e.target.value = ''; }
            });
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    showMainAppView(btn.dataset.target);
                });
            });

            document.getElementById('transfer-form').addEventListener('submit', handleTransferSubmit);
        });
    </script>
</body>
</html>